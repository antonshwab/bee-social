<!doctype html>
<html>
   <head>
       <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous">
       <link rel="stylesheet" href="css/styleSVG.css">
   </head>
    <body style="margin:0">
        <svg></svg>
    </body>
    
   <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js" integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js" integrity="sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm" crossorigin="anonymous"></script>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/golos-js@0.6.1/dist/golos.min.js"></script>
    
    
   <script>
       golos.config.set('websocket', 'wss://ws.testnet.golos.io');
       golos.config.set('address_prefix', 'GLS');
       golos.config.set('chain_id', '5876894a41e6361bde2e73278f07340f2eb8b41c2facd29099de9deef6cdb679');
       
       $(document).ready(function(){
            
          
           
           
           
            var svg = d3.select("svg")
             .attr('width',window.innerWidth)
             .attr('height',window.innerHeight);
       
           
            function redrawLines(data){
                var line = svg.selectAll("line")
                 .data(data, function(d){ return d; });
                
                line.enter().append("line")
                 .attr("x1", function(d){ return getCoord(d.from)[0];})
                 .attr("y1", function(d){ return getCoord(d.from)[1];})
                 .attr("x2", function(d){ return getCoord(d.to)[0];})
                 .attr("y2", function(d){ return getCoord(d.to)[1];})
                 .attr("stroke",function(d){return getTransactionColor(d.type);})
                 .attr("data-toggle","tooltip")
                 .attr("data-placement","right")
                 .attr("title",function(d){return d.description});
                
                line.exit().remove();
                $(function () {
                    $('[data-toggle="tooltip"]').tooltip();
                });
            }
       
            function redrawCircs(data){
                 var circle = svg.selectAll("circle")
                  .data(data, function(d) { return d; });
                
                circle.enter().append("circle")
                     .attr("cy", function(d){return d.y;})
                     .attr("cx", function(d){return d.x;})
                     .attr("r", 10)
                     .attr("id",function(d){return d.ID;})
                     .attr("fill", function(d){return getAccountColor(d.type);})
                     .attr("data-toggle","tooltip")
                     .attr("data-placement","right")
                     .attr("data-html","true")
                     .attr("title",function(d){return '<p>'+d.type+'</p><p>'+d.name+'<p></p>'+d.description+'</p>';});
                ;
                circle.exit().remove();
                $(function () {
                    $('[data-toggle="tooltip"]').tooltip();
                });
                
             }
       
       //SVG------------------------------------------
       
       //DATA-----------------------------------------
            var circs = [];
            var lines = [];
            var names = ['priorbank','imaguru','monkeyfood','ecotheatre','greenetwork','botcube','fundobra','maria-knop','anton-shvab'];
            var N=1;
            window.addEventListener('click',function(){
                
                circs = [];
                lines = [];
                    var user;
                    var currentNamesArray = names.slice(0,N);
                    golos.api.getAccounts(currentNamesArray, function(err, result) {
                        //console.log(result);
                        result.forEach(function(item,i){
                            
                            var circ = new Object();
                            circ.x = window.innerWidth/2 + 200*Math.cos(i*2*Math.PI/N);
                            circ.y = window.innerHeight/2 + 200*Math.sin(i*2*Math.PI/N);
                            circ.ID = i;
                            circ.Id = item.id;
                            circ.permName = item.name;
                            let info = JSON.parse( item.json_metadata);
                            circ.name = info.name;
                            circ.type = info.type;
                            circ.description = info.description;
                            circ.img = info.img;
                            circs.push(circ);
                            //console.log(circs);
                        });
                        redrawCircs(circs);
                        
                        /*if( N==3){
                            console.log('lines');
                            
                            //------lines-------------------------
                            /*var line = new Object();
                            let jsonMetadata1;
                            /*if(N==2){
                                jsonMetadata1 = '{"from":"priorbank","to":"imaguru","type":"project","description":"Hackathon Social Weekend","tokens":"1000","moreinfo":"24-25 February, Hackathon Social Weekend "}';
                            }*/
                            /*if(N==3){
                                jsonMetadata1 = '{"from":"imaguru","to":"monkeyfood","type":"project","description":"Hackathon Social Weekend","tokens":"1000","moreinfo":"24-25 February, Hackathon Social Weekend "}';
                            }
                            info = JSON.parse(jsonMetadata1);
                            
                            line.from = getCircByName(info.from).ID;
                            line.to = getCircByName(info.to).ID;
                            line.description = info.description;
                            line.type = info.type;
                            lines.push(line);
                            redrawLines(lines);
                        }*/
                        //искать всевозможные транзакции между существующими участниками
                        //цикл по именам
                        names.slice(0,N).forEach(function(itemName){
                            
                            //все транзакции для текущего имени
                            golos.api.getAccountHistory(itemName, -1, 100, function(err, result) {
                                //console.log(err, result);
                                
                                //отсеивание валидных транзакций
                                //если это операция трансфер + длина json'а нормальная + конечный узел существует на графе
                                result.forEach(function(item){
                                    //console.log(item[1]);
                                    if(item[1].op[0]=="transfer" 
                                       && item[1].op[1].memo.length>100 
                                       && isCircExist(item[1].op[1].to)
                                       && item[1].op[1].from == itemName
                                    ){
                                        //console.log(item);
                                        
                                        let line = new Object();
                                        let info = JSON.parse(item[1].op[1].memo);
                                        line.from = getCircByName(info.from).ID;
                                        
                                        info.to = info.to.replace(' d','');
                                        
                                        line.to = getCircByName(info.to).ID;
                                        line.description = info.description;
                                        line.type = info.type;
                                        lines.push(line);
                                        console.log('from: '+item[1].op[1].from+' to: '+item[1].op[1].to+' json: '+item[1].op[1].memo);
                                        //console.log('from: '+getTypeOfCirc(item[1].op[1].from)+' to: '+getTypeOfCirc(item[1].op[1].to));
                                    }
                                });
                                //console.log(result[17][1].op);
                            });
                        });
                        
                        N++;
                    });
                
            });
            
           function getCoord(id){
                let thisCirc = getCircById(id);
                return [thisCirc.x,thisCirc.y];
            }
            
            function getCircById(id){
                for(i=0;i<circs.length;i++){
                    if(circs[i].ID == id){
                        return circs[i];
                    }
                }
                return null;
            }
           function getCircByName(targetName){
                for(i=0;i<circs.length;i++){
                    //console.log(circs[i].permName+' '+targetName);
                    if(circs[i].permName == targetName){
                        //console.log('here');
                        return circs[i];
                    }
                }
                return null;
            }
            function getAccountColor(type){
                if(type=="npo"){
                    return "#4ad331";
                }else if(type=="sponsor"){
                    return "#eb2828";
                }else if(type=="volunteer"){
                    return "#ebf247";
                }
            }
            function getTransactionColor(type){
                if(type=="resource"){
                    return "#9036dd";
                }else if(type=="project"){
                    return "#2e9cbe";
                }
            }
            function showInfo(obj){
                let blockInfo = document.getElementsByClassName('info')[0];
                blockInfo.innerHTML = '';
                blockInfo.innerHTML = obj.description;
            }
            function hideInfo(){
                let blockInfo = document.getElementsByClassName('info')[0].innerHTML='';
            }
            
            function isCircExist(targetName){
                if(getCircByName(targetName)==null){
                    return false;
                }else{
                    return true;
                }
            }
           function getTypeOfCirc(name){
               return getCircByName(name).type;
           }
            
           
       });
       
       
       
    </script>
</html>